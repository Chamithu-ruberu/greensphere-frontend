<!DOCTYPE html>
<html
  lang="en"
  xmlns:th="http://www.thymeleaf.org"
  xmlns="http://www.w3.org/1999/html"
>
  <head>
    <title>Government User Dashboard</title>

    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <!-- plugins:css -->
    <link rel="stylesheet" href="vendors/ti-icons/css/themify-icons.css" />
    <link rel="stylesheet" href="vendors/base/vendor.bundle.base.css" />
    <!-- endinject -->
    <!-- plugin css for this page -->
    <!-- End plugin css for this page -->
    <!-- inject:css -->
    <link rel="stylesheet" href="css/style.css" />
    <!-- endinject -->
    <link rel="shortcut icon" href="images/gs-logo-.png" />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Poppins:wght@200;300;400;500;600;700&display=swap");
      @import url("https://fonts.googleapis.com/css2?family=Noto+Sans:ital,wght@0,400;0,700;1,400;1,700&display=swap");
    </style>
  </head>

  <body>
    <div class="container-scroller">
      <div class="p-0 m-0 row proBanner" id="proBanner">
        <div class="p-0 m-0 col-md-12">
          <div
            class="card-body card-body-padding d-flex align-items-center justify-content-between"
          >
            <div class="d-flex align-items-center justify-content-between">
              <a href="https://www.bootstrapdash.com/product/royalui/"
                ><i class="text-white ti-home me-3"></i
              ></a>
              <button id="bannerClose" class="p-0 border-0 btn">
                <i class="text-white ti-close me-0"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
      <!-- partial:partials/_navbar.html -->
      <nav class="flex-row p-0 navbar col-lg-12 col-12 fixed-top d-flex">
        <div
          class="text-center navbar-brand-wrapper d-flex align-items-center justify-content-center"
        >
          <a class="navbar-brand brand-logo me-5" href="govUserHome.html"
            ><img src="images/gs-logo-3.png" class="me-2" alt="logo"
          /></a>
          <a class="navbar-brand brand-logo-mini" href="home.html"
            ><img src="images/gs-logo.png" alt="logo"
          /></a>
        </div>
        <div
          class="navbar-menu-wrapper d-flex align-items-center justify-content-end"
        >
          <button
            class="navbar-toggler align-self-center"
            type="button"
            data-toggle="minimize"
          >
            <span class="ti-view-list"></span>
          </button>
          <ul class="navbar-nav mr-lg-2">
            <li class="nav-item nav-search d-none d-lg-block">
              <div class="input-group">
                <div
                  class="input-group-prepend hover-cursor"
                  id="navbar-search-icon"
                >
                  <span class="input-group-text" id="search">
                    <i class="ti-search"></i>
                  </span>
                </div>
                <input
                  type="text"
                  class="form-control"
                  id="navbar-search-input"
                  placeholder="Search now"
                  aria-label="search"
                  aria-describedby="search"
                />
              </div>
            </li>
          </ul>
          <ul class="navbar-nav navbar-nav-right">
            <li class="nav-item dropdown me-1">
              <a
                class="nav-link count-indicator dropdown-toggle d-flex justify-content-center align-items-center"
                id="messageDropdown"
                href="#"
                data-bs-toggle="dropdown"
              >
                <i class="mx-0 ti-email"></i>
              </a>
              <div
                class="dropdown-menu dropdown-menu-right navbar-dropdown"
                aria-labelledby="messageDropdown"
              >
                <p class="float-left mb-0 font-weight-normal dropdown-header">
                  Messages
                </p>
                <a class="dropdown-item">
                  <div class="item-thumbnail">
                    <img
                      src="images/faces/face4.jpg"
                      alt="image"
                      class="profile-pic"
                    />
                  </div>
                  <div class="flex-grow item-content">
                    <h6 class="ellipsis font-weight-normal">David Grey</h6>
                    <p class="mb-0 font-weight-light small-text text-muted">
                      The meeting is cancelled
                    </p>
                  </div>
                </a>
                <a class="dropdown-item">
                  <div class="item-thumbnail">
                    <img
                      src="images/faces/face2.jpg"
                      alt="image"
                      class="profile-pic"
                    />
                  </div>
                  <div class="flex-grow item-content">
                    <h6 class="ellipsis font-weight-normal">Tim Cook</h6>
                    <p class="mb-0 font-weight-light small-text text-muted">
                      New product launch
                    </p>
                  </div>
                </a>
                <a class="dropdown-item">
                  <div class="item-thumbnail">
                    <img
                      src="images/faces/face3.jpg"
                      alt="image"
                      class="profile-pic"
                    />
                  </div>
                  <div class="flex-grow item-content">
                    <h6 class="ellipsis font-weight-normal">Johnson</h6>
                    <p class="mb-0 font-weight-light small-text text-muted">
                      Upcoming board meeting
                    </p>
                  </div>
                </a>
              </div>
            </li>
            <li class="nav-item dropdown">
              <a
                class="nav-link count-indicator dropdown-toggle"
                id="notificationDropdown"
                href="#"
                data-bs-toggle="dropdown"
              >
                <i class="mx-0 ti-bell"></i>
                <span class="count"></span>
              </a>
              <div
                class="dropdown-menu dropdown-menu-right navbar-dropdown"
                aria-labelledby="notificationDropdown"
              >
                <p class="float-left mb-0 font-weight-normal dropdown-header">
                  Notifications
                </p>
                <a class="dropdown-item">
                  <div class="item-thumbnail">
                    <div class="item-icon bg-success">
                      <i class="mx-0 ti-info-alt"></i>
                    </div>
                  </div>
                  <div class="item-content">
                    <h6 class="font-weight-normal">Application Error</h6>
                    <p class="mb-0 font-weight-light small-text text-muted">
                      Just now
                    </p>
                  </div>
                </a>
                <a class="dropdown-item">
                  <div class="item-thumbnail">
                    <div class="item-icon bg-warning">
                      <i class="mx-0 ti-settings"></i>
                    </div>
                  </div>
                  <div class="item-content">
                    <h6 class="font-weight-normal">Settings</h6>
                    <p class="mb-0 font-weight-light small-text text-muted">
                      Private message
                    </p>
                  </div>
                </a>
                <a class="dropdown-item">
                  <div class="item-thumbnail">
                    <div class="item-icon bg-info">
                      <i class="mx-0 ti-user"></i>
                    </div>
                  </div>
                  <div class="item-content">
                    <h6 class="font-weight-normal">New user registration</h6>
                    <p class="mb-0 font-weight-light small-text text-muted">
                      2 days ago
                    </p>
                  </div>
                </a>
              </div>
            </li>
            <li class="nav-item nav-profile dropdown">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                data-bs-toggle="dropdown"
                id="profileDropdown"
              >
                <img src="images/faces/face28.jpg" alt="profile" />
              </a>
              <div
                class="dropdown-menu dropdown-menu-right navbar-dropdown"
                aria-labelledby="profileDropdown"
              >
                <a class="dropdown-item" href="GovuserProfile.html">
                  <i class="ti-settings text-primary"></i>
                  Settings
                </a>
                <a class="dropdown-item" onclick="handleLogout()">
                  <i class="ti-power-off text-primary"></i>
                  Logout
                </a>
              </div>
            </li>
          </ul>
          <button
            class="navbar-toggler navbar-toggler-right d-lg-none align-self-center"
            type="button"
            data-toggle="offcanvas"
          >
            <span class="ti-view-list"></span>
          </button>
        </div>
      </nav>
      <!-- partial -->
      <div class="container-fluid page-body-wrapper">
        <!-- partial:partials/_sidebar.html -->
        <nav class="sidebar sidebar-offcanvas" id="sidebar">
          <ul class="nav">
            <li class="nav-item">
              <a class="nav-link" href="appUserHome.html">
                <i class="ti-shield menu-icon"></i>
                <span class="menu-title">Users</span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/pages/forms/basic_elements.html">
                <i class="ti-layout-list-post menu-icon"></i>
                <span class="menu-title">user Uploads</span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/pages/charts/chartjs.html">
                <i class="ti-pie-chart menu-icon"></i>
                <span class="menu-title">Daily schedule</span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/pages/tables/basic-table.html">
                <i class="ti-view-list-alt menu-icon"></i>
                <span class="menu-title">Usage Report</span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/pages/icons/themify.html">
                <i class="ti-star menu-icon"></i>
                <span class="menu-title">Payments</span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/documentation/documentation.html">
                <i class="ti-write menu-icon"></i>
                <span class="menu-title">Offers Add +</span>
              </a>
            </li>
          </ul>
        </nav>
        <script>
          function handleLogout() {
            const token = localStorage.getItem("token");

            if (token) {
              fetch("http://localhost:8082/user/logout", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({ token: token }),
              })
                .then((response) => {
                  if (response.ok) {
                    // Clear all local storage
                    localStorage.clear();

                    // Redirect to the index page
                    window.location.href = "/index.html";
                  } else {
                    console.error("Logout failed");
                    // Handle any errors here
                  }
                })
                .catch((error) => {
                  console.error("An error occurred:", error);
                });
            } else {
              console.error("No token found in local storage");
              // Handle the case where the token is missing
            }
          }
        </script>
        <!-- partial -->
        <div class="main-panel">
          <div class="content-wrapper">
            <div class="row">
              <div class="col-md-12 grid-margin">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <h4 class="mb-0 font-weight-bold">
                      Greensphere Waste Collection Service
                    </h4>
                  </div>
                  <div>
                    <button
                      type="button"
                      class="btn btn-primary btn-icon-text btn-rounded"
                    >
                      <i class="ti-clipboard btn-icon-prepend"></i>Report
                    </button>
                  </div>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 grid-margin stretch-card">
                <div class="card">
                  <div class="card-body">
                    <p class="card-title">Waste Collection Data</p>
                    <p class="text-muted font-weight-light">
                      All Active Waste Collection data up to now.
                    </p>

                    <!-- Search Input -->
                    <input
                      type="text"
                      id="searchCategory"
                      placeholder="Search by Category"
                      class="mb-3 form-control"
                    />

                    <!-- Table Structure -->
                    <table class="table table-hover" id="wasteDataTable">
                      <thead>
                        <tr>
                          <th>Waste ID</th>
                          <th>Category</th>
                          <th>Weight</th>
                          <th>Location</th>
                        </tr>
                      </thead>
                      <tbody>
                        <!-- Data will be populated here -->
                      </tbody>
                    </table>

                    <!-- View All Button -->
                    <button
                      class="border-0 btn btn-lg btn-outline-light text-primary rounded-0 d-none d-md-block"
                      id="viewAllButton"
                      type="button"
                    >
                      View all
                    </button>
                  </div>
                </div>
              </div>

              <div class="col-md-6 grid-margin stretch-card">
                <div class="card border-bottom-0">
                  <div class="pb-0 card-body">
                    <p class="card-title">
                      Assign Transport Users to Collect Waste
                    </p>
                    <p class="text-muted font-weight-light">
                      Correctly Assign Users with Locations nearby.
                    </p>
                    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBEBSjGbXcpCyB4BkfW1cD6a2a39PhuWgw&callback=initMap"></script>

                    <div id="map" style="height: 400px; width: 100%"></div>
                    <form id="assign-transport-form">
                      <label for="users">Assign Driver:</label>
                      <select id="users" name="userId" class="form-control">
                        <!-- User options will be populated here -->
                      </select>
                      <input type="hidden" id="wasteId" name="wasteId" />
                      <input
                        type="hidden"
                        id="geolocation"
                        name="geolocation"
                      />
                      <button
                        class="border-0 btn btn-lg btn-outline-light text-primary rounded-0 d-none d-md-block"
                        id="viewAllButton"
                        type="submit"
                      >
                        Assign
                      </button>
                    </form>
                  </div>
                </div>
              </div>
            </div>

            <script>
              function initMap() {
                // Center the map to a default location
                var defaultLocation = { lat: 6.82199, lng: 80.040479 }; // Example coordinates
                var map = new google.maps.Map(document.getElementById("map"), {
                  zoom: 12,
                  center: defaultLocation,
                });
              }

              function showLocationOnMap(geolocation) {
                const [lat, lng] = geolocation.split(",").map(Number); // Assuming `geolocation` is a string like "latitude,longitude"
                const location = { lat, lng };
                const map = new google.maps.Map(
                  document.getElementById("map"),
                  {
                    zoom: 12,
                    center: location,
                  }
                );

                // Place a marker on the map
                new google.maps.Marker({
                  position: location,
                  map: map,
                });
              }

              function loadDriversNearby(geolocation) {
                // Fetch nearby drivers based on geolocation
                fetch(
                  `http://127.0.0.1:8082/api/v1/users/nearby?geolocation=${geolocation}`
                )
                  .then((response) => response.json())
                  .then((users) => {
                    const userSelect = document.getElementById("users");
                    userSelect.innerHTML = ""; // Clear previous options
                    users.forEach((user) => {
                      const option = document.createElement("option");
                      option.value = user.id;
                      option.textContent = user.name;
                      userSelect.appendChild(option);
                    });
                  })
                  .catch((error) =>
                    console.error("Error fetching users:", error)
                  );
              }

              document
                .getElementById("assign-transport-form")
                .addEventListener("submit", function (event) {
                  event.preventDefault();
                  const wasteId = document.getElementById("wasteId").value;
                  const userId = document.getElementById("users").value;
                  const geolocation =
                    document.getElementById("geolocation").value;

                  // Check that wasteId and other parameters are properly set
                  if (!wasteId) {
                    alert(
                      "Waste ID is not set. Please select a waste item from the table."
                    );
                    return;
                  }
                  console.log("waste id from submit :", wasteId);
                  console.log("waste id from submit :", geolocation);
                  // Construct the URL with query parameters
                  const url = `http://127.0.0.1:8081/api/v1/transport/save?wasteId=${wasteId}&userId=1&geolocation=${encodeURIComponent(
                    geolocation
                  )}`;

                  fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                  })
                    .then((response) => {
                      // Check if the response is JSON
                      const contentType = response.headers.get("content-type");
                      if (
                        contentType &&
                        contentType.includes("application/json")
                      ) {
                        return response.json(); // Parse JSON response
                      } else {
                        return response.text(); // Parse as text if not JSON
                      }
                    })
                    .then((result) => {
                      // Handle the result based on its type
                      if (typeof result === "object") {
                        alert(result.message);
                      } else {
                        alert(result); // Handle plain text response
                      }
                    })
                    .catch((error) =>
                      console.error("Error assigning transport:", error)
                    );
                });
            </script>
            <script>
              document.addEventListener("DOMContentLoaded", function () {
                const wasteDataTable = document
                  .getElementById("wasteDataTable")
                  .querySelector("tbody");
                const searchCategory =
                  document.getElementById("searchCategory");
                const viewAllButton = document.getElementById("viewAllButton");

                // Retrieve token and username from local storage
                const username = localStorage.getItem("username");
                const token = localStorage.getItem("token");

                // Initialize headers with the Authorization token
                const headers = new Headers();
                headers.append("Authorization", `Bearer ${token}`);

                // Fetch and Display All Waste Data
                function fetchWasteData() {
                  fetch("http://127.0.0.1:8081/api/v1/transport", {
                    method: "GET",
                    headers: headers,
                  })
                    .then((response) => response.json())
                    .then((data) => populateTable(data))
                    .catch((error) =>
                      console.error("Error fetching data:", error)
                    );
                }

                // Populate Table with Data
                function populateTable(data) {
                  wasteDataTable.innerHTML = ""; // Clear existing rows
                  data.forEach((waste) => {
                    const row = document.createElement("tr");
                    const [lat, lng] = waste.location
                      .split(", ")
                      .map((coord) => parseFloat(coord).toFixed(2));
                    const roundedLocation = `${lat}, ${lng}`;
                    row.innerHTML = `
          <td>${waste.id}</td>
          <td>${waste.category}</td>
          <td>${waste.weight}</td>
          <td>${roundedLocation}</td>
        `;
                    // Add click event to each row
                    row.addEventListener("click", () => {
                      // Set wasteId and geolocation in the hidden inputs
                      document.getElementById("wasteId").value = waste.id;
                      document.getElementById("geolocation").value =
                        waste.location; // Assuming location is in "lat,lng" format
                      showLocationOnMap(waste.location);
                      loadDriversNearby(waste.location); // Load drivers based on location

                      // Debugging logs
                      console.log("Waste ID set:", waste.id);
                      console.log("Geolocation set:", waste.location);
                    });
                    wasteDataTable.appendChild(row);
                  });
                }

                // Fetch Data by Category
                searchCategory.addEventListener("input", function () {
                  const category = searchCategory.value;
                  if (category) {
                    fetch(
                      `http://127.0.0.1:8081/api/v1/transport/findCategory?category=${encodeURIComponent(
                        category
                      )}`,
                      {
                        method: "POST",
                        headers: headers,
                      }
                    )
                      .then((response) => response.json())
                      .then((data) => populateTable(data))
                      .catch((error) =>
                        console.error("Error fetching data:", error)
                      );
                  } else {
                    fetchWasteData(); // Show all if search is cleared
                  }
                });

                // View All Button Event
                viewAllButton.addEventListener("click", fetchWasteData);

                // Fetch all data on page load
                fetchWasteData();
              });
            </script>

            <div class="row">
              <div class="col-md-13 grid-margin stretch-card">
                <div class="card">
                  <div class="card-body">
                    <p class="mb-0 card-title">Transport Data</p>
                    <div class="table-responsive">
                      <table class="table table-hover" id="transportDataTable">
                        <thead>
                          <tr>
                            <th>ID</th>
                            <th>Waste ID</th>
                            <th>User ID</th>
                            <th>Geolocation</th>
                            <th>Actions</th>
                          </tr>
                        </thead>
                        <tbody>
                          <!-- Data rows will be appended here -->
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
              <script>
                const username = localStorage.getItem("username");

                const token = localStorage.getItem("token");
                const headers = new Headers();
                headers.append("Authorization", `Bearer ${token}`);
                // Fetch transport data and display in the table
                function loadTransportData() {
                  fetch("http://127.0.0.1:8081/api/v1/transport/all", {
                    method: "GET",
                    headers: headers,
                  })
                    .then((response) => response.json())
                    .then((data) => {
                      const tableBody = document
                        .getElementById("transportDataTable")
                        .getElementsByTagName("tbody")[0];
                      tableBody.innerHTML = ""; // Clear existing data
                      data.forEach((transport) => {
                        const row = document.createElement("tr");
                        const [lat, lng] = transport.geolocation
                          .split(", ")
                          .map((coord) => parseFloat(coord).toFixed(2));
                        const roundedLocation = `${lat}, ${lng}`;
                        row.innerHTML = `
                                            <td>${transport.id}</td>
                                            <td>${transport.wasteId}</td>
                                            <td>${transport.userId}</td>
                                            <td>${roundedLocation}</td>
                                            <td>
   
                                            <button class="border-0 btn btn-lg btn-outline-light text-primary rounded-0 d-none d-md-block" onclick="deleteTransportData(${transport.id})" > Delete </button>
                                               
                                            </td>
                                        `;
                        tableBody.appendChild(row);
                      });
                    })
                    .catch((error) =>
                      console.error("Error loading transport data:", error)
                    );
                }

                // Delete transport data by ID
                function deleteTransportData(transportId) {
                  fetch(
                    `http://127.0.0.1:8081/api/v1/transport/delete?id=${transportId}`,
                    {
                      method: "POST",
                      headers: {
                        "Content-Type": "application/x-www-form-urlencoded",
                        headers: headers,
                      },
                    }
                  )
                    .then((response) => response.text())
                    .then((message) => {
                      alert(message);
                      loadTransportData(); // Refresh data after deletion
                    })
                    .catch((error) =>
                      console.error("Error deleting transport data:", error)
                    );
                }

                // Load transport data on page load
                document.addEventListener(
                  "DOMContentLoaded",
                  loadTransportData
                );
              </script>

              <!-- content-wrapper ends -->
              <!-- partial:partials/_footer.html -->
              <footer class="footer">
                <div
                  class="d-sm-flex justify-content-center justify-content-sm-between"
                >
                  <span
                    class="text-center text-muted text-sm-left d-block d-sm-inline-block"
                    >Copyright ©
                    <a href="" target="_blank">wastemanage.lk </a>2024</span
                  >
                  <span
                    class="float-none mt-1 text-center float-sm-right d-block mt-sm-0"
                    >Only the best
                    <a href="" target="_blank"> Waste Collect</a>
                    Processing</span
                  >
                </div>
              </footer>
            </div>
            <!-- main-panel ends -->
          </div>
          <!-- page-body-wrapper ends -->
        </div>
        <!-- container-scroller -->
      </div>
    </div>
    <!-- plugins:js -->
    <script src="vendors/base/vendor.bundle.base.js"></script>
    <!-- endinject -->
    <!-- Plugin js for this page-->
    <script src="vendors/chart.js/Chart.min.js"></script>
    <script src="js/jquery.cookie.js" type="text/javascript"></script>
    <!-- End plugin js for this page-->
    <!-- inject:js -->
    <script src="js/off-canvas.js"></script>
    <script src="js/hoverable-collapse.js"></script>
    <script src="js/template.js"></script>
    <script src="js/todolist.js"></script>
    <!-- endinject -->
    <!-- Custom js for this page-->
    <script src="js/dashboard.js"></script>
    <!-- End custom js for this page-->
  </body>
</html>
